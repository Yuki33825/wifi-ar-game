<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ËÑ±Ëµ∞Wi-Fi„ÇíÊçï„Åæ„Åà„ÇçÔºÅ</title>

  <!-- A-Frame + AR.js CDN -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 24px 16px;
      box-sizing: border-box;
    }

    #title-bar {
      text-align: center;
      background: rgba(0, 0, 0, 0.55);
      border-radius: 12px;
      padding: 12px 16px;
    }

    #title-bar h1 {
      margin: 0;
      font-size: 18px;
      color: #fff;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
    }

    #status-bar {
      text-align: center;
      background: rgba(0, 0, 0, 0.55);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s ease;
    }

    #status-bar.caught {
      background: rgba(0, 180, 80, 0.85);
    }

    #status-message {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: #fff;
      font-weight: bold;
    }

    #wifi-info {
      display: none;
      margin-top: 12px;
      color: #fff;
      font-size: 14px;
      line-height: 1.8;
    }

    #wifi-info .label {
      opacity: 0.8;
    }

    #wifi-info .value {
      font-weight: bold;
      font-size: 18px;
      background: rgba(255, 255, 255, 0.15);
      padding: 2px 10px;
      border-radius: 6px;
      letter-spacing: 1px;
    }

    #wifi-info .hint {
      margin-top: 12px;
      font-size: 12px;
      opacity: 0.8;
    }

    /* Ë∑ùÈõ¢ÔºÜÁä∂ÊÖãHUD */
    #hud-info {
      position: fixed;
      bottom: 120px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 9999;
      pointer-events: none;
    }

    #dist-text {
      color: #fff;
      font-size: 22px;
      font-weight: bold;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.8);
    }

    #dist-trend {
      margin-top: 4px;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
    }

    #dist-trend.approaching {
      color: #44ff88;
    }

    #dist-trend.receding {
      color: #ff6666;
    }

    #proximity-bar-wrap {
      margin: 8px auto 0;
      width: 180px;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
    }

    #proximity-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff88);
      border-radius: 4px;
      transition: width 0.2s;
    }

    /* „Ç≤„ÉÉ„ÉàÊºîÂá∫ */
    #catch-flash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
    }

    #catch-flash.active {
      opacity: 1;
    }

    /* Èü≥Â£∞ÊúâÂäπÂåñ„Ç™„Éº„Éê„Éº„É¨„Ç§ÔºàiOS SafariÁî®Ôºâ */
    #audio-unlock {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10001;
      pointer-events: auto;
      display: none;
    }

    /* ÈÉ®Â±ã„Çµ„Ç§„Ç∫Ë®≠ÂÆöUI */
    #room-config {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      /* More opaque */
      backdrop-filter: blur(10px);
      /* Blur background */
      border-radius: 16px;
      padding: 24px;
      z-index: 9999;
      pointer-events: auto;
      font-size: 14px;
      color: #fff;
      width: 300px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #room-config h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      color: #00ddff;
      text-align: center;
    }

    .config-row {
      margin-bottom: 16px;
    }

    .config-row label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .config-row input[type=range] {
      width: 100%;
      accent-color: #00ddff;
    }

    #room-config button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      background: #444;
      color: #fff;
      transition: background 0.2s;
    }

    #room-config button:active {
      background: #666;
    }

    #room-config button#reset-position {
      background: #00ddff;
      color: #000;
      margin-bottom: 12px;
    }

    #room-config button#start-game {
      background: #00ff88;
      color: #000;
    }
  </style>
</head>

<body>

  <!-- „Ç≤„ÉÉ„ÉàÊôÇ„Éï„É©„ÉÉ„Ç∑„É• -->
  <div id="catch-flash"></div>

  <!-- Èü≥Â£∞ÊúâÂäπÂåñ„Ç™„Éº„Éê„Éº„É¨„Ç§ÔºàiOS SafariÁî®„ÉªÂàùÂõû„Çø„ÉÉ„Éó„ÅßÈü≥Â£∞unlockÔºâ -->
  <div id="audio-unlock"></div>

  <!-- ÈÉ®Â±ã„Çµ„Ç§„Ç∫Ë®≠ÂÆöUI -->
  <div id="room-config">
    <h3>„Éó„É¨„Ç§„Ç®„É™„Ç¢Ë®≠ÂÆö</h3>

    <div class="config-row">
      <label>ÂπÖ (Width): <span id="val-width">5.0m</span></label>
      <input type="range" id="room-width" min="2.0" max="10.0" step="0.5" value="5.0">
    </div>

    <div class="config-row">
      <label>Â••Ë°å (Depth): <span id="val-depth">6.0m</span></label>
      <input type="range" id="room-depth" min="2.0" max="10.0" step="0.5" value="6.0">
    </div>

    <div class="config-row">
      <label>È´ò„Åï (Height): <span id="val-height">2.5m</span></label>
      <input type="range" id="room-height" min="1.5" max="5.0" step="0.1" value="2.5">
    </div>

    <button id="reset-position">üìç ÁõÆ„ÅÆÂâç„Å´ÈÖçÁΩÆ</button>
    <button id="start-game">„Ç≤„Éº„É†ÈñãÂßã</button>
  </div>

  <!-- UI„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
  <div id="overlay">
    <div id="title-bar">
      <h1>ËÑ±Ëµ∞„Åó„ÅüWi-Fi„ÇíËøΩ„ÅÑ„Åã„Åë„ÇçÔºÅ</h1>
      <div style="margin-top:8px;">
        <a href="/webxr"
          style="display:inline-block; padding:8px 16px; background:rgba(0, 221, 255, 0.8); color:#000; text-decoration:none; border-radius:20px; font-weight:bold; font-size:12px;">
          üöÄ È´òÁ≤æÂ∫¶(WebXR)Áâà„ÇíË©¶„Åô
        </a>
      </div>
    </div>
    <div id="status-bar" style="display: none;">
      <p id="status-message"></p>
      <div id="wifi-info">
        <div><span class="label">SSIDÔºö</span><span class="value" id="ssid-value"></span></div>
        <div style="margin-top:6px"><span class="label">PASSÔºö</span><span class="value" id="pass-value"></span></div>
        <p class="hint">Ë®≠ÂÆö„Ç¢„Éó„É™„ÇíÈñã„ÅÑ„Å¶„ÄÅ„Åì„ÅÆWi-Fi„Å´Êé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
      </div>
    </div>
  </div>

  <!-- Ë∑ùÈõ¢HUD -->
  <div id="hud-info">
    <div id="dist-text"></div>
    <div id="dist-trend"></div>
    <div id="proximity-bar-wrap">
      <div id="proximity-bar"></div>
    </div>
    <!-- Ê≠©Ë°åÊ§úÁü•„Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Ôºà„Éá„Éï„Ç©„É´„ÉàÈùûË°®Á§∫Ôºâ -->
    <div id="debug-info" style="
      margin-top: 8px; 
      font-size: 10px; 
      color: rgba(255,255,255,0.7); 
      display: none;
    "></div>
  </div>

  <!-- ========================================
       A-Frame„Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÂÆöÁæ©
       ======================================== -->
  <script>
    /* ============================================================
       „ÉÅ„É•„Éº„Éã„É≥„Ç∞Áî®„Éë„É©„É°„Éº„ÇøÔºà„Åì„Åì„ÇíÂ§â„Åà„Çã„Å®ÊåôÂãï„ÅåÂ§â„Çè„ÇãÔºâ
       ============================================================ */

    // Wi-FiÁßªÂãï ‚îÄ ÂçäÂæÑ„ÇíÂ§â„Åà„Çã„Å®È£õ„Å≥Âõû„ÇãÁØÑÂõ≤„ÅåÂ§â„Çè„Çã
    const MOVE_RADIUS_MIN = 4;
    const MOVE_RADIUS_MAX = 6;

    // Wi-FiÁßªÂãï ‚îÄ ÈÄüÂ∫¶(m/s)„ÇíÂ§â„Åà„Çã„Å®ÁßªÂãï„ÅÆÈÄü„Åï„ÅåÂ§â„Çè„Çã
    const MOVE_SPEED = 0.8;

    // Wi-FiÁßªÂãï ‚îÄ „Çø„Éº„Ç≤„ÉÉ„ÉàÂà∞ÁùÄÂæå„ÅÆÂæÖÊ©üÊôÇÈñì(Áßí)
    const MOVE_WAIT_MIN = 0.5;
    const MOVE_WAIT_MAX = 2.0;

    // „Ç≤„ÉÉ„ÉàÂà§ÂÆö ‚îÄ Ë∑ùÈõ¢(m)„ÇíÂ∞è„Åï„Åè„Åô„Çã„Å®Ëøë„Å•„Åã„Å™„ÅÑ„Å®Êçï„Åæ„Åà„Çâ„Çå„Å™„ÅÑ
    const CATCH_DISTANCE = 1.2;

    // „Ç≤„ÉÉ„ÉàÂà§ÂÆö ‚îÄ „Ç´„É°„É©„ÅåWi-Fi„ÅÆÊñπ„ÇíÂêë„ÅÑ„Å¶„ÅÑ„ÇãÂøÖË¶Å„Åå„ÅÇ„ÇãËßíÂ∫¶(Â∫¶)
    // „Åì„ÅÆËßíÂ∫¶‰ª•ÂÜÖ„Å´Êçâ„Åà„Å¶„ÅÑ„Å™„ÅÑ„Å®„Ç≤„ÉÉ„Éà„Åß„Åç„Å™„ÅÑ
    const CATCH_ANGLE = 60;

    // Wi-FiÁßªÂãï ‚îÄ „Åì„ÅÆË∑ùÈõ¢„Åæ„ÅßËøë„Å•„ÅÑ„Åü„ÇâWi-Fi„ÅåÂÅúÊ≠¢„Åô„Çã(m)
    // CATCH_DISTANCE‰ª•‰∏ã„Å´„Åô„Çã„Å®Âü∫Êú¨ÁöÑ„Å´Âãï„ÅçÁ∂ö„Åë„Çã
    const FREEZE_DISTANCE = CATCH_DISTANCE; // Êçï„Åæ„Åà„ÇãÁû¨Èñì„Å†„ÅëÂÅúÊ≠¢

    // ËªåË∑° ‚îÄ ÁîüÊàêÈñìÈöî(Áßí)„ÇíÂ∞è„Åï„Åè„Åô„Çã„Å®ËªåË∑°„ÅåÂØÜ„Å´„Å™„Çã
    const TRAIL_INTERVAL = 0.15;

    // ËªåË∑° ‚îÄ ÁîüÂ≠òÊôÇÈñì(Áßí)„ÇíÈï∑„Åè„Åô„Çã„Å®ËªåË∑°„ÅåÈï∑„ÅèÊÆã„Çã
    const TRAIL_LIFETIME = 3.0;

    // ËªåË∑° ‚îÄ ‰∏äÈôêÊï∞„ÇíË∂Ö„Åà„Çã„Å®Âè§„ÅÑ„ÇÇ„ÅÆ„Åã„ÇâÂâäÈô§
    const TRAIL_MAX_COUNT = 80;

    // Ë°®Á§∫„Åô„ÇãWi-FiÊÉÖÂ†±ÔºàÂæå„ÅßÂ∑Æ„ÅóÊõø„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºâ
    const WIFI_SSID = 'MEETING_WIFI';
    const WIFI_PASS = 'password123';

    // Wi-Fi„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈ´ò„Åï„Ç™„Éï„Çª„ÉÉ„ÉàÔºà„Ç´„É°„É©Âü∫Ê∫ñÔºâ
    const WIFI_HEIGHT_MIN = -0.5;
    const WIFI_HEIGHT_MAX = 1.5;

    // ËøëÊé•Èü≥ ‚îÄ „Éì„Éº„Éó„ÅÆÂë®Ê≥¢Êï∞ÁØÑÂõ≤(Hz)„ÇíÂ§â„Åà„Çã„Å®Èü≥„ÅÆÈ´ò„Åï„ÅåÂ§â„Çè„Çã
    const BEEP_FREQ_FAR = 300;      // ÈÅ†„ÅÑ„Å®„Åç„ÅÆÂë®Ê≥¢Êï∞
    const BEEP_FREQ_NEAR = 1200;    // Ëøë„ÅÑ„Å®„Åç„ÅÆÂë®Ê≥¢Êï∞

    // ËøëÊé•Èü≥ ‚îÄ „Éì„Éº„ÉóÈñìÈöî(Áßí)„ÇíÂ§â„Åà„Çã„Å®È≥¥„ÇãÈ†ªÂ∫¶„ÅåÂ§â„Çè„Çã
    const BEEP_INTERVAL_FAR = 1.5;  // ÈÅ†„ÅÑ„Å®„Åç„ÅÆÈñìÈöî
    const BEEP_INTERVAL_NEAR = 0.1; // Ëøë„ÅÑ„Å®„Åç„ÅÆÈñìÈöî

    // ËøëÊé•Èü≥ ‚îÄ „Éì„Éº„Éó„ÅåÈ≥¥„ÇäÂßã„ÇÅ„ÇãË∑ùÈõ¢(m)
    const BEEP_START_DISTANCE = 8.0;

    // ËøëÊé•Èü≥ ‚îÄ „Éì„Éº„Éó1Âõû„ÅÆÈï∑„Åï(Áßí)
    const BEEP_DURATION = 0.08;

    // Ë∑ùÈõ¢„Çπ„Ç±„Éº„É™„É≥„Ç∞ ‚îÄ Wi-Fi„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆË¶ã„ÅüÁõÆ„Çµ„Ç§„Ç∫
    const SCALE_AT_FAR = 0.4;       // ÈÅ†„ÅÑ„Å®„ÅçÔºàÂ∞è„Åï„ÅèÔºâ
    const SCALE_AT_NEAR = 1.5;      // Ëøë„ÅÑ„Å®„ÅçÔºàÂ§ß„Åç„ÅèÔºâ
    const SCALE_FAR_DIST = 8.0;     // „ÄåÈÅ†„ÅÑ„Äç„Å®„Åø„Å™„ÅôË∑ùÈõ¢
    const SCALE_NEAR_DIST = 1.0;    // „ÄåËøë„ÅÑ„Äç„Å®„Åø„Å™„ÅôË∑ùÈõ¢

    /* ============================================================
       „Ç≤„Éº„É†Áä∂ÊÖã
       ============================================================ */
    let gameCaught = false;
    let gameStarted = false;  // AR„Ç∑„Éº„É≥„ÅÆÊ∫ñÂÇôÂÆå‰∫ÜÂæå„Å´true„Å´„Åô„Çã
    let audioUnlocked = false;

    /* ============================================================
       ÈÉ®Â±ã„Çµ„Ç§„Ç∫ÔºÜÂéüÁÇπÔºàÂãïÁöÑ„Å´Â§âÊõ¥ÂèØËÉΩÔºâ
       ============================================================ */
    let roomSize = {
      width: 5.0,   // XËª∏ÊñπÂêë
      depth: 6.0,   // ZËª∏ÊñπÂêë
      height: 2.5   // YËª∏ÊñπÂêë
    };
    let roomOrigin = new THREE.Vector3(0, 0, 0);  // ÈÉ®Â±ã„ÅÆ‰∏≠ÂøÉÔºàÂ∫äÈù¢Ôºâ

    /* ============================================================
       Web Audio API ‚îÄ ËøëÊé•„Éì„Éº„ÉóÈü≥
       ============================================================ */
    let audioCtx = null;
    let lastBeepTime = 0;

    function initAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        console.warn('AudioContext not supported', e);
      }
    }

    function unlockAudio() {
      if (audioUnlocked || !audioCtx) return;
      // iOS Safari„ÅØ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂæå„Å´AudioContext„ÇíÂÜçÈñã„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
      // „ÉÄ„Éü„ÉºÈü≥„ÇíÂÜçÁîü„Åó„Å¶Èü≥Â£∞unlock
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      gain.gain.value = 0;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.01);
      audioUnlocked = true;
    }

    function playBeep(frequency, volume) {
      if (!audioCtx || gameCaught) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = frequency;
      gain.gain.value = volume;
      // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà„Åß„Éó„ÉÅ„Éé„Ç§„Ç∫Èò≤Ê≠¢
      gain.gain.setTargetAtTime(0, audioCtx.currentTime + BEEP_DURATION * 0.7, 0.01);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + BEEP_DURATION);
    }

    // „Ç≤„ÉÉ„ÉàÊôÇ„ÅÆÂäπÊûúÈü≥Ôºà‰∏äÊòáÈü≥Ôºâ
    function playCatchSound() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.setValueAtTime(400, audioCtx.currentTime);
      osc.frequency.linearRampToValueAtTime(1600, audioCtx.currentTime + 0.3);
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.setTargetAtTime(0, audioCtx.currentTime + 0.3, 0.05);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }

    // Ë∑ùÈõ¢„Å´Âøú„Åò„Åü„Éì„Éº„ÉóÂá¶ÁêÜÔºàÊØé„Éï„É¨„Éº„É†Âëº„Å∞„Çå„ÇãÔºâ
    function updateProximityBeep(distance, now) {
      if (!audioCtx || gameCaught || distance > BEEP_START_DISTANCE) return;

      // Ë∑ùÈõ¢„Çí0„Äú1„Å´Ê≠£Ë¶èÂåñÔºà0=Ëøë„ÅÑ, 1=ÈÅ†„ÅÑÔºâ
      const t = Math.max(0, Math.min(1,
        (distance - CATCH_DISTANCE) / (BEEP_START_DISTANCE - CATCH_DISTANCE)
      ));

      // „Éì„Éº„ÉóÈñìÈöî: Ëøë„ÅÑ„Åª„Å©Áü≠„ÅÑ
      const interval = BEEP_INTERVAL_NEAR + t * (BEEP_INTERVAL_FAR - BEEP_INTERVAL_NEAR);

      if (now - lastBeepTime >= interval) {
        // Âë®Ê≥¢Êï∞: Ëøë„ÅÑ„Åª„Å©È´ò„ÅÑ
        const freq = BEEP_FREQ_NEAR + t * (BEEP_FREQ_FAR - BEEP_FREQ_NEAR);
        // Èü≥Èáè: Ëøë„ÅÑ„Åª„Å©Â§ß„Åç„ÅÑ (0.05„Äú0.25)
        const vol = 0.05 + (1 - t) * 0.2;
        playBeep(freq, vol);
        lastBeepTime = now;
      }
    }

    /* ============================================================
       „Ç≤„Éº„É†ÂàùÊúüÂåñ„ÉªÈü≥Â£∞unlockÔºàiOS SafariÂØæÂøúÔºâ
       ============================================================ */
    document.addEventListener('DOMContentLoaded', function () {
      // AudioContext„Çí‰∫ãÂâç„Å´ÂàùÊúüÂåñ
      initAudio();

      // ÂàùÂõû„Çø„ÉÉ„Éó„ÅßÈü≥Â£∞unlockÔºàiOS SafariÁî®Ôºâ
      const unlockOverlay = document.getElementById('audio-unlock');
      if (unlockOverlay) {
        unlockOverlay.addEventListener('click', function () {
          unlockAudio();
          unlockOverlay.style.display = 'none';
        }, { once: true });
      }

      // Âøµ„ÅÆ„Åü„ÇÅÁîªÈù¢ÂÖ®‰Ωì„ÅÆ„Çø„ÉÉ„Éó„Åß„ÇÇunlockË©¶Ë°å
      document.body.addEventListener('touchstart', function () {
        if (audioCtx && !audioUnlocked) {
          unlockAudio();
        }
      }, { once: true });

      // --- Ë®≠ÂÆöUI„ÅÆÊõ¥Êñ∞„É≠„Ç∏„ÉÉ„ÇØ ---
      const inputs = {
        width: document.getElementById('room-width'),
        depth: document.getElementById('room-depth'),
        height: document.getElementById('room-height')
      };
      const displays = {
        width: document.getElementById('val-width'),
        depth: document.getElementById('val-depth'),
        height: document.getElementById('val-height')
      };

      function updateRoomSize() {
        roomSize.width = parseFloat(inputs.width.value);
        roomSize.depth = parseFloat(inputs.depth.value);
        roomSize.height = parseFloat(inputs.height.value);

        displays.width.textContent = roomSize.width.toFixed(1) + 'm';
        displays.depth.textContent = roomSize.depth.toFixed(1) + 'm';
        displays.height.textContent = roomSize.height.toFixed(1) + 'm';

        // Â¢ÉÁïå„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
        const boundaryBox = document.getElementById('boundary-box');
        if (boundaryBox && boundaryBox.components['boundary-box-updater']) {
          boundaryBox.components['boundary-box-updater'].updateBox();
        }

        // Wi-Fi„ÅÆ‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„ÉàÔºàÈÉ®Â±ãÂÜÖ„Å´Âèé„ÇÅ„ÇãÔºâ
        const wifiEl = document.getElementById('wifi-entity');
        if (wifiEl && wifiEl.components['wifi-mover']) {
          // „Åæ„Å†„Ç≤„Éº„É†ÈñãÂßãÂâç„Å™„Çâ‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà„Åô„ÇãÂøÖË¶Å„ÅØ„Å™„ÅÑ„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„Åå„ÄÅ
          // Â£Å„ÅÆÂ§ñ„Å´Âá∫„Å¶„Åó„Åæ„Å£„Å¶„ÅÑ„Çã„Å®Ë¶ãÂ§±„ÅÜ„ÅÆ„ÅßÂøµ„ÅÆ„Åü„ÇÅ
          if (gameStarted) wifiEl.components['wifi-mover'].resetPosition();
        }
      }

      // „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
      Object.values(inputs).forEach(input => {
        input.addEventListener('input', updateRoomSize);
      });

      // „ÄåÁõÆ„ÅÆÂâç„Å´ÈÖçÁΩÆ„Äç„Éú„Çø„É≥
      const resetPosBtn = document.getElementById('reset-position');
      if (resetPosBtn) {
        resetPosBtn.addEventListener('click', function () {
          const cameraEl = document.querySelector('[camera]');
          if (cameraEl) {
            const camPos = new THREE.Vector3();
            cameraEl.object3D.getWorldPosition(camPos);

            // „Ç´„É°„É©„ÅÆÂêë„ÅçÔºàYËª∏ÂõûËª¢„ÅÆ„ÅøËÄÉÊÖÆÔºâ„ÇíÂèñÂæó
            const camRot = new THREE.Euler().setFromQuaternion(cameraEl.object3D.quaternion, 'YXZ');

            // ÂâçÊñπ2m„ÅÆ‰ΩçÁΩÆ„ÇíË®àÁÆó
            const forward = new THREE.Vector3(0, 0, -2); // 2mÂâçÊñπ
            forward.applyAxisAngle(new THREE.Vector3(0, 1, 0), camRot.y);

            roomOrigin.copy(camPos).add(forward);
            roomOrigin.y = 0; // Â∫ä„ÅÆÈ´ò„Åï„ÅØÂõ∫ÂÆöÔºà0Ôºâ„Å®‰ªÆÂÆö
            // ‚ÄªÂ∞ÜÊù•ÁöÑ„Å´„ÅØ„Ç´„É°„É©„ÅÆÈ´ò„Åï„ÇíËÄÉÊÖÆ„Åó„Å¶Â∫äÈ´ò„Åï„ÇíÊé®ÂÆö„Åô„Çã„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å¶„ÇÇËâØ„ÅÑ

            console.log('Room origin reset to:', roomOrigin);

            // Â¢ÉÁïå„Éú„ÉÉ„ÇØ„ÇπÊõ¥Êñ∞
            const boundaryBox = document.getElementById('boundary-box');
            if (boundaryBox && boundaryBox.components['boundary-box-updater']) {
              boundaryBox.components['boundary-box-updater'].updateBox();
            }
          }
        });
      }

      // „Ç≤„Éº„É†ÈñãÂßã„Éú„Çø„É≥
      const startBtn = document.getElementById('start-game');
      if (startBtn) {
        startBtn.addEventListener('click', function () {
          gameStarted = true;
          console.log('Game manually started!');

          // room-config„Éë„Éç„É´„ÇíÈùûË°®Á§∫
          const roomConfig = document.getElementById('room-config');
          if (roomConfig) {
            roomConfig.style.display = 'none';
          }

          // iOS 13+ Âä†ÈÄüÂ∫¶„Çª„É≥„Çµ„Éº„ÅÆË®±ÂèØ„É™„ÇØ„Ç®„Çπ„Éà
          if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission()
              .then(permissionState => {
                if (permissionState === 'granted') {
                  const cameraEl = document.querySelector('[camera]');
                  if (cameraEl && cameraEl.components['motion-walk']) {
                    cameraEl.components['motion-walk'].enable();
                  }
                } else {
                  alert('Ê≠©Ë°åÊ§úÁü•„ÅÆ„Åü„ÇÅ„Å´„ÅØ„Çª„É≥„Çµ„ÉºË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô');
                }
              })
              .catch(console.error);
          } else {
            // Android„Å™„Å©Ë®±ÂèØ‰∏çË¶Å„Å™Â†¥Âêà„ÇÇÊúâÂäπÂåñ
            const cameraEl = document.querySelector('[camera]');
            if (cameraEl && cameraEl.components['motion-walk']) {
              cameraEl.components['motion-walk'].enable();
            }
          }

          // „Ç≤„Éº„É†ÈñãÂßãÊôÇ„Å´Wi-Fi„ÇíÂàùÊúüÈÖçÁΩÆ
          const wifiEl = document.getElementById('wifi-entity');
          if (wifiEl && wifiEl.components['wifi-mover']) {
            wifiEl.components['wifi-mover'].resetPosition();
            wifiEl.setAttribute('visible', true);
          }

          // Â¢ÉÁïå„Éú„ÉÉ„ÇØ„Çπ„ÇíÁõÆÁ´ã„Åü„Å™„Åè„Åô„ÇãÔºà„Åæ„Åü„ÅØÊ∂à„ÅôÔºâ
          // ‰ªäÂõû„ÅØ„ÄåËâ≤‰ªò„ÅçÂçäÈÄèÊòé„Äç„ÅÆ„Åæ„ÅæÊÆã„Åô„Åå„ÄÅ„Éó„É¨„Ç§„ÅÆÈÇ™È≠î„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜÈÄèÊòéÂ∫¶„Çí‰∏ã„Åí„Çã
          const boundaryBox = document.getElementById('boundary-box');
          if (boundaryBox) {
            boundaryBox.setAttribute('material', 'opacity', 0.1);
          }
        });
      }

      // A-Frame„Ç∑„Éº„É≥„ÅåÂÆåÂÖ®„Å´„É≠„Éº„Éâ„Åï„Çå„Åü„ÇâÂàùÊúüÂåñ
      const scene = document.querySelector('a-scene');
      if (scene) {
        scene.addEventListener('renderstart', function () {
          console.log('AR scene render started');
          setTimeout(function () {
            // ÂàùÊúü‰ΩçÁΩÆ„ÇíË®≠ÂÆöÔºà„Å®„Çä„ÅÇ„Åà„ÅöÂéüÁÇπ„ÅÆÂâçÊñπÔºâ
            // „ÄåÁõÆ„ÅÆÂâç„Å´ÈÖçÁΩÆ„Äç„Éú„Çø„É≥„Åß„É¶„Éº„Ç∂„Éº„ÅåË™øÊï¥„Åô„Çã„Åì„Å®„ÇíÂâçÊèê„Å®„Åô„Çã
            const cameraEl = document.querySelector('[camera]');
            if (cameraEl) {
              const camPos = new THREE.Vector3();
              cameraEl.object3D.getWorldPosition(camPos);
              const forward = new THREE.Vector3(0, 0, -3);
              forward.applyQuaternion(cameraEl.object3D.quaternion);
              roomOrigin.copy(camPos).add(forward);
              roomOrigin.y = 0;
            }

            // Â¢ÉÁïå„Éú„ÉÉ„ÇØ„Çπ„ÇíË°®Á§∫
            const boundaryBox = document.getElementById('boundary-box');
            if (boundaryBox) {
              boundaryBox.setAttribute('visible', true);
              if (boundaryBox.components['boundary-box-updater']) {
                boundaryBox.components['boundary-box-updater'].updateBox();
              }
            }
          }, 500);
        });
      } else {
        console.warn('Scene not found');
      }
    });

    /* ============================================================
       „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
       ============================================================ */
    function randBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    // ÈÉ®Â±ãÂéüÁÇπ„Åã„Çâ„ÅÆÁõ∏ÂØæÂ∫ßÊ®ô„Åß„É©„É≥„ÉÄ„É†‰ΩçÁΩÆ„ÇíÁîüÊàê
    function generateRandomPositionInRoom() {
      const halfW = roomSize.width / 2;
      const halfD = roomSize.depth / 2;
      const relX = randBetween(-halfW, halfW);
      const relZ = randBetween(-halfD, halfD);
      const relY = randBetween(0.3, roomSize.height - 0.3); // Â∫ä„ÉªÂ§©‰∫ï„Åã„ÇâÂ∞ë„ÅóÈõ¢„Åô
      return roomOrigin.clone().add(new THREE.Vector3(relX, relY, relZ));
    }

    // ÈÄüÂ∫¶„Éô„ÇØ„Éà„É´ÂèçÂ∞Ñ„ÇíÂê´„ÇÄÂ¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
    // pos„ÅØÁµ∂ÂØæÂ∫ßÊ®ô„ÄÅvelocity„ÅØÈÄüÂ∫¶„Éô„ÇØ„Éà„É´
    function bounceOffWalls(pos, velocity) {
      const rel = pos.clone().sub(roomOrigin);
      const halfW = roomSize.width / 2;
      const halfD = roomSize.depth / 2;

      // XÊñπÂêë
      if (rel.x > halfW) {
        rel.x = halfW;
        velocity.x = -Math.abs(velocity.x);
      } else if (rel.x < -halfW) {
        rel.x = -halfW;
        velocity.x = Math.abs(velocity.x);
      }

      // ZÊñπÂêë
      if (rel.z > halfD) {
        rel.z = halfD;
        velocity.z = -Math.abs(velocity.z);
      } else if (rel.z < -halfD) {
        rel.z = -halfD;
        velocity.z = Math.abs(velocity.z);
      }

      // YÊñπÂêëÔºàÂ∫ä„ÉªÂ§©‰∫ïÔºâ
      if (rel.y < 0) {
        rel.y = 0;
        velocity.y = Math.abs(velocity.y);
      } else if (rel.y > roomSize.height) {
        rel.y = roomSize.height;
        velocity.y = -Math.abs(velocity.y);
      }

      pos.copy(rel.add(roomOrigin));
    }

    // Ë∑ùÈõ¢„Åã„Çâ„Çπ„Ç±„Éº„É´ÂÄ§„ÇíË®àÁÆó
    function distanceToScale(distance) {
      const t = Math.max(0, Math.min(1,
        (distance - SCALE_NEAR_DIST) / (SCALE_FAR_DIST - SCALE_NEAR_DIST)
      ));
      return SCALE_AT_NEAR + t * (SCALE_AT_FAR - SCALE_AT_NEAR);
    }

    /* ============================================================
       wifi-mover „Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÔºàÈÄüÂ∫¶„Éô„Éº„Çπ + Â£ÅÂèçÂ∞ÑÔºâ
       ============================================================ */
    AFRAME.registerComponent('wifi-mover', {
      init: function () {
        this.velocity = new THREE.Vector3(
          randBetween(-MOVE_SPEED, MOVE_SPEED),
          randBetween(-MOVE_SPEED * 0.5, MOVE_SPEED * 0.5),
          randBetween(-MOVE_SPEED, MOVE_SPEED)
        );
        this.stopped = false;
        this.frozen = false;
        this.cameraEl = null;
        this.initialized = false;
      },

      tick: function (time, delta) {
        if (this.stopped || gameCaught) return;
        if (!gameStarted) return;

        const dt = delta / 1000;

        if (!this.cameraEl) {
          this.cameraEl = document.querySelector('[camera]');
          if (!this.cameraEl) return;
        }

        // ÂàùÂõûÔºöÈÉ®Â±ãÂÜÖ„ÅÆ„É©„É≥„ÉÄ„É†‰ΩçÁΩÆ„Å´ÈÖçÁΩÆ
        if (!this.initialized) {
          const startPos = generateRandomPositionInRoom();
          this.el.object3D.position.copy(startPos);
          this.initialized = true;
          return;
        }

        // „Éó„É¨„Ç§„É§„Éº„ÅåËøë„Å•„ÅÑ„Åü„ÇâÂáçÁµêÔºàFREEZE_DISTANCE‰ª•‰∏ã„Å™„ÇâÂÅúÊ≠¢Ôºâ
        const cameraPos = new THREE.Vector3();
        this.cameraEl.object3D.getWorldPosition(cameraPos);
        const distToCamera = this.el.object3D.position.distanceTo(cameraPos);
        if (distToCamera <= FREEZE_DISTANCE) {
          this.frozen = true;
        } else {
          this.frozen = false;
        }

        if (this.frozen) return;

        // ÈÄüÂ∫¶„Éô„Éº„Çπ„Åß‰ΩçÁΩÆÊõ¥Êñ∞
        const pos = this.el.object3D.position;
        pos.add(this.velocity.clone().multiplyScalar(dt));

        // Â£Å„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆöÔºãÂèçÂ∞Ñ
        bounceOffWalls(pos, this.velocity);
      },

      resetPosition: function () {
        // ÈÉ®Â±ã„Çµ„Ç§„Ç∫Â§âÊõ¥ÊôÇ„Å™„Å©„Å´Âëº„Å∞„Çå„Çã
        const newPos = generateRandomPositionInRoom();
        this.el.object3D.position.copy(newPos);
        // ÈÄüÂ∫¶„Éô„ÇØ„Éà„É´„ÇÇ„É™„Çª„ÉÉ„Éà
        this.velocity.set(
          randBetween(-MOVE_SPEED, MOVE_SPEED),
          randBetween(-MOVE_SPEED * 0.5, MOVE_SPEED * 0.5),
          randBetween(-MOVE_SPEED, MOVE_SPEED)
        );
      },

      stopMoving: function () {
        this.stopped = true;
      }
    });

    /* ============================================================
       motion-walk „Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÔºàÁñë‰ºº6DoFÔºöÊ≠©Ë°åÊ§úÁü•Ôºâ
       ============================================================ */
    AFRAME.registerComponent('motion-walk', {
      schema: {
        enabled: { default: false },
        threshold: { default: 2.0 }, // Âä†ÈÄüÂ∫¶Â§âÂåñ„ÅÆÊ§úÁü•ÈñæÂÄ§ÔºàË™øÊï¥ÂøÖË¶ÅÔºâ
        stepSize: { default: 0.5 },  // ‰∏ÄÊ≠©„ÅßÈÄ≤„ÇÄË∑ùÈõ¢(m)
        debug: { default: false }    // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫
      },

      init: function () {
        this.accelY = 0;
        this.lastAccelY = 0;
        this.peakY = 0;
        this.stepCooldown = 0;
        this.debugEl = document.getElementById('debug-info');

        this.onDeviceMotion = this.onDeviceMotion.bind(this);

        // Android„Å™„Å©Ë®±ÂèØ‰∏çË¶Å„Å™Â†¥Âêà„ÅØÂç≥ÊôÇ„É™„Çπ„Éä„ÉºÁôªÈå≤ÔºàÊúâÂäπÂåñ„ÅØ„Çπ„Ç≠„Éº„Éû„ÅßÂà∂Âæ°Ôºâ
        window.addEventListener('devicemotion', this.onDeviceMotion);
      },

      enable: function () {
        this.data.enabled = true;
        if (this.data.debug && this.debugEl) {
          this.debugEl.style.display = 'block';
        }
      },

      onDeviceMotion: function (event) {
        if (!this.data.enabled) return;

        // ÈáçÂäõÂä†ÈÄüÂ∫¶„ÇíÂê´„ÇÄÂä†ÈÄüÂ∫¶„ÇíÂèñÂæó
        const acc = event.accelerationIncludingGravity;
        if (!acc) return;

        // „É≠„Éº„Éë„Çπ„Éï„Ç£„É´„ÇøÔºàÁ∞°ÊòìÔºâ
        const alpha = 0.8;
        this.accelY = alpha * this.accelY + (1 - alpha) * (acc.y || 0);
      },

      tick: function (time, delta) {
        if (!this.data.enabled || gameCaught) return;

        const dt = delta / 1000;

        // Ê≠©Ë°åÂãï‰ΩúÔºà‰∏ä‰∏ãÂãïÔºâ„ÅÆÊ§úÂá∫„É≠„Ç∏„ÉÉ„ÇØ
        // ÂçòÁ¥î„Å™„Éî„Éº„ÇØÊ§úÂá∫: ÂâçÂõû„Çà„Çä‰∏ã„Åå„Å£„Åü„Çø„Ç§„Éü„É≥„Ç∞„Åß„Éî„Éº„ÇØ„Å®„Åø„Å™„Åô
        // „Åã„Å§„ÄÅÈñæÂÄ§‰ª•‰∏ä„ÅÆÂ§âÂåñ„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà

        // Â§âÂåñÈáè
        const deltaY = Math.abs(this.accelY - this.lastAccelY);

        // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥‰∏≠„ÅØÁÑ°Ë¶ñÔºàÈÄ£Á∂öÊ§úÁü•Èò≤Ê≠¢Ôºâ
        if (this.stepCooldown > 0) {
          this.stepCooldown -= dt;
        } else {
          // Á∞°Êòì„É≠„Ç∏„ÉÉ„ÇØ: ‰∏ÄÂÆö‰ª•‰∏ä„ÅÆÂ§âÂåñ„Åå„ÅÇ„Å£„Åü„Çâ„Äå‰∏ÄÊ≠©„Äç„Å®„Åø„Å™„Åô
          // ‚ÄªÂÆüÊ©üË™øÊï¥„ÅåÂøÖË¶Å„Å™ÈÉ®ÂàÜ„ÄÇ„Åì„Åì„Åß„ÅØ„ÄåÈñæÂÄ§‰ª•‰∏äÂ§âÂåñ„Åó„ÄÅ„Åã„Å§„Éî„Éº„ÇØ„ÇíË∂ä„Åà„Åü„Äç„Å®‰ªÆÂÆö
          if (deltaY > this.data.threshold) {
            this.takeStep();
            this.stepCooldown = 0.6; // Ê¨°„ÅÆ‰∏ÄÊ≠©„Åæ„Åß„ÅÆÊúÄ‰ΩéÊôÇÈñìÔºàÁßíÔºâ
          }
        }

        this.lastAccelY = this.accelY;

        if (this.data.debug && this.debugEl) {
          this.debugEl.textContent = `AccelY: ${this.accelY.toFixed(2)} | Step: ${this.stepCooldown > 0 ? 'Wait' : 'Ready'}`;
        }
      },

      takeStep: function () {
        // „Ç´„É°„É©„ÅÆÂêë„ÅÑ„Å¶„ÅÑ„ÇãÊñπÂêëÔºàXZÂπ≥Èù¢Ôºâ„Å´ÈÄ≤„ÇÄ
        const el = this.el;
        const direction = new THREE.Vector3();

        // „Ç´„É°„É©„ÅÆÊ≠£Èù¢„Éô„ÇØ„Éà„É´„ÇíÂèñÂæó
        el.sceneEl.camera.getWorldDirection(direction);
        direction.y = 0; // ‰∏ä‰∏ãÁßªÂãï„ÅØ„Åó„Å™„ÅÑ
        direction.normalize();

        // ÁèæÂú®‰ΩçÁΩÆ„Å´Âä†ÁÆó
        const pos = el.getAttribute('position');
        const newPos = {
          x: pos.x + direction.x * this.data.stepSize,
          y: pos.y, // YÂ∫ßÊ®ô„ÅØÂ§â„Åà„Å™„ÅÑ
          z: pos.z + direction.z * this.data.stepSize
        };

        // ÈÉ®Â±ã„ÅÆÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÁ∞°ÊòìÁâàÔºâ
        // ‚ÄªÂé≥ÂØÜ„Å´„ÅØÂ£ÅË°ùÁ™ÅÂà§ÂÆö„ÇíÂÖ•„Çå„Çã„Åπ„Åç„Å†„Åå„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÅØÂ£Å„ÇíÁ™Å„ÅçÊäú„Åë„Å™„ÅÑÂâçÊèê„Å®„Åô„Çã
        // ‰∏ÄÂøúÈÉ®Â±ã„ÅÆÂ§ñ„Å´Âá∫ÈÅé„Åé„Å™„ÅÑ„Çà„ÅÜ„Å´„ÇØ„É©„É≥„Éó
        const halfW = roomSize.width / 2;
        const halfD = roomSize.depth / 2;

        // ÂéüÁÇπ„Ç™„Éï„Çª„ÉÉ„Éà„ÇíËÄÉÊÖÆ„Åó„Å¶Áõ∏ÂØæ‰ΩçÁΩÆ„ÅßÂà§ÂÆö
        const relX = newPos.x - roomOrigin.x;
        const relZ = newPos.z - roomOrigin.z;

        if (relX > halfW) newPos.x = roomOrigin.x + halfW;
        if (relX < -halfW) newPos.x = roomOrigin.x - halfW;
        if (relZ > halfD) newPos.z = roomOrigin.z + halfD;
        if (relZ < -halfD) newPos.z = roomOrigin.z - halfD;

        el.setAttribute('position', newPos);

        // ÊºîÂá∫ÔºöÂ∞ë„ÅóÊè∫„Çâ„ÅôÔºàÊ≠©„ÅÑ„Å¶„ÅÑ„ÇãÊÑüÔºâ
        // ‰ªäÂõûÁúÅÁï•

        console.log('Step taken!', newPos);

        // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Êõ¥Êñ∞
        if (this.data.debug && this.debugEl) {
          this.debugEl.style.color = '#00ff00';
          setTimeout(() => { if (this.debugEl) this.debugEl.style.color = 'rgba(255,255,255,0.7)'; }, 200);
        }
      }
    });

    /* ============================================================
       trail-system „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
       ============================================================ */
    AFRAME.registerComponent('trail-system', {
      init: function () {
        this.trails = [];
        this.lastSpawn = 0;
        this.stopped = false;
        this.sceneEl = this.el.sceneEl;
      },

      tick: function (time, delta) {
        const now = time / 1000;

        if (!this.stopped && !gameCaught && gameStarted) {
          if (now - this.lastSpawn >= TRAIL_INTERVAL) {
            this.spawnTrail(now);
            this.lastSpawn = now;
          }
        }

        for (let i = this.trails.length - 1; i >= 0; i--) {
          const trail = this.trails[i];
          const age = now - trail.createdAt;

          if (age >= TRAIL_LIFETIME) {
            if (trail.el.parentNode) {
              trail.el.parentNode.removeChild(trail.el);
            }
            this.trails.splice(i, 1);
            continue;
          }

          const opacity = 1.0 - (age / TRAIL_LIFETIME);
          const mesh = trail.el.getObject3D('mesh');
          if (mesh && mesh.material) {
            mesh.material.opacity = opacity * 0.6;
          }
        }
      },

      spawnTrail: function (now) {
        while (this.trails.length >= TRAIL_MAX_COUNT) {
          const oldest = this.trails.shift();
          if (oldest.el.parentNode) {
            oldest.el.parentNode.removeChild(oldest.el);
          }
        }

        const wifiPos = this.el.object3D.position;
        const trailEl = document.createElement('a-sphere');
        trailEl.setAttribute('radius', '0.06');
        trailEl.setAttribute('color', '#00ccff');
        trailEl.setAttribute('material', 'transparent: true; opacity: 0.6');
        trailEl.setAttribute('position', `${wifiPos.x} ${wifiPos.y} ${wifiPos.z}`);

        this.sceneEl.appendChild(trailEl);
        this.trails.push({ el: trailEl, createdAt: now });
      },

      stopTrails: function () {
        this.stopped = true;
      }
    });

    /* ============================================================
       catch-checker „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
       Ë∑ùÈõ¢Áõ£Ë¶ñ + „Éì„Éº„ÉóÈü≥ + ÊñπÂêëÁü¢Âç∞ + „Çπ„Ç±„Éº„É™„É≥„Ç∞ + „Ç≤„ÉÉ„ÉàÂà§ÂÆö
       ============================================================ */
    AFRAME.registerComponent('catch-checker', {
      init: function () {
        this.wifiEl = null;
        this.distText = document.getElementById('dist-text');
        this.distTrend = document.getElementById('dist-trend');
        this.proximityBar = document.getElementById('proximity-bar');
        this.hudInfo = document.getElementById('hud-info');
        this._prevDistance = null;
        this._camWorldPos = new THREE.Vector3();
        this._wifiWorldPos = new THREE.Vector3();
        this._camDir = new THREE.Vector3();
        this._toWifi = new THREE.Vector3();
      },

      tick: function (time) {
        if (gameCaught) {
          if (this.hudInfo) this.hudInfo.style.display = 'none';
          return;
        }
        if (!gameStarted) return;

        if (!this.wifiEl) {
          this.wifiEl = document.getElementById('wifi-entity');
          if (!this.wifiEl) return;
        }

        const now = time / 1000;

        // Â∫ßÊ®ôÂèñÂæó
        this.el.object3D.getWorldPosition(this._camWorldPos);
        const wifiPos = this.wifiEl.object3D.position;
        this._wifiWorldPos.copy(wifiPos);

        const dist = this._camWorldPos.distanceTo(this._wifiWorldPos);

        // --- Ë∑ùÈõ¢„ÉÜ„Ç≠„Çπ„Éà ---
        if (this.distText) {
          this.distText.textContent = dist.toFixed(1) + 'm';
        }

        // --- Ë∑ùÈõ¢„Éà„É¨„É≥„ÉâÔºàËøë„Å•„ÅÑ„Å¶„ÅÑ„Çã/ÈÅ†„Åñ„Åã„Å£„Å¶„ÅÑ„ÇãÔºâ ---
        const TREND_THRESHOLD = 0.05;
        if (this.distTrend && this._prevDistance !== null) {
          const diff = this._prevDistance - dist;
          if (diff > TREND_THRESHOLD) {
            this.distTrend.textContent = '‚Üë Ëøë„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô';
            this.distTrend.className = 'approaching';
            this.distTrend.style.display = '';
          } else if (diff < -TREND_THRESHOLD) {
            this.distTrend.textContent = '‚Üì ÈÅ†„Åñ„Åã„Å£„Å¶„ÅÑ„Åæ„Åô';
            this.distTrend.className = 'receding';
            this.distTrend.style.display = '';
          } else {
            this.distTrend.style.display = 'none';
          }
        }
        this._prevDistance = dist;

        // --- ËøëÊé•„Éê„ÉºÔºà0„Äú100%Ôºâ ---
        if (this.proximityBar) {
          const pct = Math.max(0, Math.min(100,
            (1 - (dist - CATCH_DISTANCE) / (BEEP_START_DISTANCE - CATCH_DISTANCE)) * 100
          ));
          this.proximityBar.style.width = pct + '%';
        }

        // --- „Ç´„É°„É©ÂâçÊñπ„Åã„Çâ„ÅÆÁõ∏ÂØæËßíÂ∫¶„ÇíË®àÁÆó ---
        const angleDeg = this.getAngleToWifi();
        const absAngle = Math.abs(angleDeg);

        // --- Ë∑ùÈõ¢„Å´Âøú„Åò„Åü„Çπ„Ç±„Éº„É™„É≥„Ç∞ ---
        const s = distanceToScale(dist);
        this.wifiEl.object3D.scale.set(s, s, s);

        // --- ËøëÊé•„Éì„Éº„ÉóÈü≥ ---
        updateProximityBeep(dist, now);

        // --- „Ç≤„ÉÉ„ÉàÂà§ÂÆöÔºàË∑ùÈõ¢ÔºãË¶ñÁïåÂÜÖ„ÉÅ„Çß„ÉÉ„ÇØÔºâ ---
        if (dist <= CATCH_DISTANCE && absAngle <= CATCH_ANGLE) {
          this.onCaught();
        }
      },

      // „Ç´„É°„É©ÂâçÊñπ„Åã„ÇâWi-Fi„Å∏„ÅÆÁõ∏ÂØæËßíÂ∫¶(Â∫¶)„ÇíËøî„Åô
      getAngleToWifi: function () {
        this._camDir.set(0, 0, -1);
        this._camDir.applyQuaternion(this.el.object3D.quaternion);
        const camAngle = Math.atan2(this._camDir.x, this._camDir.z);

        this._toWifi.subVectors(this._wifiWorldPos, this._camWorldPos);
        const wifiAngle = Math.atan2(this._toWifi.x, this._toWifi.z);

        let relAngle = wifiAngle - camAngle;
        while (relAngle > Math.PI) relAngle -= Math.PI * 2;
        while (relAngle < -Math.PI) relAngle += Math.PI * 2;

        return relAngle * (180 / Math.PI);
      },

      onCaught: function () {
        gameCaught = true;
        console.log('GOT WIFI!');

        const wifiEl = this.wifiEl;

        // Wi-FiÁßªÂãïÂÅúÊ≠¢
        if (wifiEl.components['wifi-mover']) {
          wifiEl.components['wifi-mover'].stopMoving();
        }
        // ËªåË∑°ÁîüÊàêÂÅúÊ≠¢
        if (wifiEl.components['trail-system']) {
          wifiEl.components['trail-system'].stopTrails();
        }

        // „Ç≤„ÉÉ„ÉàÂäπÊûúÈü≥
        playCatchSound();

        // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
        const flash = document.getElementById('catch-flash');
        flash.classList.add('active');
        setTimeout(function () {
          flash.classList.remove('active');
        }, 300);

        // Wi-Fi„ÇíÂ§ß„Åç„ÅèÂÖâ„Çâ„Åõ„Å¶„Åã„ÇâÊ∂à„ÅôÔºàË¶ã„Åà„ÇãÊºîÂá∫Ôºâ
        const currentScale = wifiEl.object3D.scale.x;
        wifiEl.setAttribute('animation__grow', {
          property: 'scale',
          to: `${currentScale * 1.8} ${currentScale * 1.8} ${currentScale * 1.8}`,
          dur: 300,
          easing: 'easeOutQuad'
        });

        // 0.3ÁßíÂæå„Å´Á∏ÆÂ∞è„Åó„Å¶Ê∂à„Åô
        setTimeout(function () {
          wifiEl.setAttribute('animation__shrink', {
            property: 'scale',
            to: '0.01 0.01 0.01',
            dur: 600,
            easing: 'easeInQuad'
          });
        }, 300);

        // UIÊõ¥Êñ∞ÔºàÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶ÊºîÂá∫Âæå„Å´Ë°®Á§∫Ôºâ
        setTimeout(function () {
          const statusBar = document.getElementById('status-bar');
          const statusMessage = document.getElementById('status-message');
          const wifiInfo = document.getElementById('wifi-info');

          statusBar.style.display = 'block';
          statusBar.classList.add('caught');
          statusMessage.textContent = 'Wi-Fi„ÇíÊçï„Åæ„Åà„Åæ„Åó„ÅüÔºÅ';
          document.getElementById('ssid-value').textContent = WIFI_SSID;
          document.getElementById('pass-value').textContent = WIFI_PASS;
          wifiInfo.style.display = 'block';
        }, 600);
      }
    });

    /* ============================================================
       wifi-rotate „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
       ============================================================ */
    AFRAME.registerComponent('wifi-rotate', {
      tick: function (time, delta) {
        if (gameCaught) return;
        this.el.object3D.rotation.y += (delta / 1000) * 1.5;
      }
    });

    /* ============================================================
       boundary-box-updater „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
       ============================================================ */
    AFRAME.registerComponent('boundary-box-updater', {
      init: function () {
        this.positioned = false;
        this.updateBox();
      },

      updateBox: function () {
        // roomOrigin„ÅÆ‰∏≠ÂøÉ„ÄÅYËª∏„ÅØÈ´ò„Åï„ÅÆÂçäÂàÜ„Ç™„Éï„Çª„ÉÉ„Éà
        const centerY = roomOrigin.y + roomSize.height / 2;
        this.el.setAttribute('position', {
          x: roomOrigin.x,
          y: centerY,
          z: roomOrigin.z
        });

        // geometry„ÇíÁõ¥Êé•Êõ¥Êñ∞
        this.el.setAttribute('geometry', {
          primitive: 'box',
          width: roomSize.width,
          height: roomSize.height,
          depth: roomSize.depth
        });
      },

      tick: function () {
        if (!this.positioned && roomOrigin && roomOrigin.lengthSq() > 0) {
          this.updateBox();
          this.positioned = true;
        }
      }
    });
  </script>

  <!-- ========================================
       A-Frame AR„Ç∑„Éº„É≥
       ======================================== -->
  <a-scene embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    renderer="logarithmicDepthBuffer: true; colorManagement: true;" vr-mode-ui="enabled: false">

    <!-- „É¶„Éº„Ç∂„ÉºÔºà„Ç´„É°„É©Ôºâ -->
    <!-- motion-walk„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÇíËøΩÂä† -->
    <a-entity camera look-controls wasd-controls position="0 1.6 0" catch-checker
      motion-walk="threshold: 1.5; stepSize: 0.6; debug: true"></a-entity>

    <!-- Wi-FiÈ£õË°åÁØÑÂõ≤„ÅÆË¶ñË¶öÂåñ -->
    <a-entity id="boundary-box" boundary-box-updater
      material="color: #ff0000; transparent: true; opacity: 0.4; side: double; depthTest: false"
      visible="false"></a-entity>

    <!-- Wi-Fi„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà -->
    <a-entity id="wifi-entity" wifi-mover trail-system wifi-rotate position="0 0 -4" visible="false">
      <!-- „Ç¢„É≥„ÉÜ„ÉäÔºà„É™„É≥„Ç∞Ôºâ -->
      <a-torus color="#00ddff" radius="0.45" radius-tubular="0.03" arc="90" rotation="0 0 45"
        material="transparent: true; opacity: 0.9"></a-torus>
      <a-torus color="#44eeff" radius="0.3" radius-tubular="0.03" arc="90" rotation="0 0 45"
        material="transparent: true; opacity: 0.9"></a-torus>
      <a-torus color="#88ffff" radius="0.15" radius-tubular="0.03" arc="90" rotation="0 0 45"
        material="transparent: true; opacity: 0.9"></a-torus>
      <!-- Êú¨‰ΩìÔºàÁêÉÔºâ -->
      <a-sphere color="#ffffff" radius="0.06" position="0 -0.08 0"
        material="transparent: true; opacity: 0.95"></a-sphere>
      <!-- Áô∫ÂÖâ„Ç®„Éï„Çß„ÇØ„Éà -->
      <a-sphere color="#00ccff" radius="0.55" material="transparent: true; opacity: 0.08; side: double"></a-sphere>
    </a-entity>

    <!-- „É©„Ç§„Éà -->
    <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
    <a-light type="directional" color="#ffffff" intensity="1" position="-1 2 1"></a-light>

  </a-scene>
</body>

</html>